import{on as e,removeListener as r,getDeviceList as t,LIBUSB_ENDPOINT_IN as n,LIBUSB_ENDPOINT_OUT as i,LIBUSB_TRANSFER_TYPE_BULK as s,LIBUSB_TRANSFER_TYPE_INTERRUPT as o,LIBUSB_RECIPIENT_DEVICE as c,LIBUSB_RECIPIENT_INTERFACE as a,LIBUSB_RECIPIENT_ENDPOINT as u,LIBUSB_RECIPIENT_OTHER as l,LIBUSB_REQUEST_TYPE_STANDARD as f,LIBUSB_REQUEST_TYPE_CLASS as d,LIBUSB_REQUEST_TYPE_VENDOR as h,LIBUSB_TRANSFER_STALL as v,LIBUSB_TRANSFER_OVERFLOW as p}from"usb";function E(){}function m(){m.init.call(this)}function g(e){return void 0===e._maxListeners?m.defaultMaxListeners:e._maxListeners}function w(e,r,t,n){var i,s,o,c;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",r,t.listener?t.listener:t),s=e._events),o=s[r]):(s=e._events=new E,e._eventsCount=0),o){if("function"==typeof o?o=s[r]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),!o.warned&&(i=g(e))&&i>0&&o.length>i){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+r+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=r,a.count=o.length,c=a,"function"==typeof console.warn?console.warn(c):console.log(c)}}else o=s[r]=t,++e._eventsCount;return e}function b(e,r,t){var n=!1;function i(){e.removeListener(r,i),n||(n=!0,t.apply(e,arguments))}return i.listener=t,i}function _(e){var r=this._events;if(r){var t=r[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function I(e,r){for(var t=new Array(r);r--;)t[r]=e[r];return t}E.prototype=Object.create(null),m.EventEmitter=m,m.usingDomains=!1,m.prototype.domain=void 0,m.prototype._events=void 0,m.prototype._maxListeners=void 0,m.defaultMaxListeners=10,m.init=function(){this.domain=null,m.usingDomains&&(void 0).active&&(void 0).Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new E,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},m.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},m.prototype.getMaxListeners=function(){return g(this)},m.prototype.emit=function(e){var r,t,n,i,s,o,c,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(c=this.domain,a){if(r=arguments[1],!c){if(r instanceof Error)throw r;var u=new Error('Uncaught, unspecified "error" event. ('+r+")");throw u.context=r,u}return r||(r=new Error('Uncaught, unspecified "error" event')),r.domainEmitter=this,r.domain=c,r.domainThrown=!1,c.emit("error",r),!1}if(!(t=o[e]))return!1;var l="function"==typeof t;switch(n=arguments.length){case 1:!function(e,r,t){if(r)e.call(t);else for(var n=e.length,i=I(e,n),s=0;s<n;++s)i[s].call(t)}(t,l,this);break;case 2:!function(e,r,t,n){if(r)e.call(t,n);else for(var i=e.length,s=I(e,i),o=0;o<i;++o)s[o].call(t,n)}(t,l,this,arguments[1]);break;case 3:!function(e,r,t,n,i){if(r)e.call(t,n,i);else for(var s=e.length,o=I(e,s),c=0;c<s;++c)o[c].call(t,n,i)}(t,l,this,arguments[1],arguments[2]);break;case 4:!function(e,r,t,n,i,s){if(r)e.call(t,n,i,s);else for(var o=e.length,c=I(e,o),a=0;a<o;++a)c[a].call(t,n,i,s)}(t,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(n-1),s=1;s<n;s++)i[s-1]=arguments[s];!function(e,r,t,n){if(r)e.apply(t,n);else for(var i=e.length,s=I(e,i),o=0;o<i;++o)s[o].apply(t,n)}(t,l,this,i)}return!0},m.prototype.addListener=function(e,r){return w(this,e,r,!1)},m.prototype.on=m.prototype.addListener,m.prototype.prependListener=function(e,r){return w(this,e,r,!0)},m.prototype.once=function(e,r){if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');return this.on(e,b(this,e,r)),this},m.prototype.prependOnceListener=function(e,r){if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,b(this,e,r)),this},m.prototype.removeListener=function(e,r){var t,n,i,s,o;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(t=n[e]))return this;if(t===r||t.listener&&t.listener===r)0==--this._eventsCount?this._events=new E:(delete n[e],n.removeListener&&this.emit("removeListener",e,t.listener||r));else if("function"!=typeof t){for(i=-1,s=t.length;s-- >0;)if(t[s]===r||t[s].listener&&t[s].listener===r){o=t[s].listener,i=s;break}if(i<0)return this;if(1===t.length){if(t[0]=void 0,0==--this._eventsCount)return this._events=new E,this;delete n[e]}else!function(e,r){for(var t=r,n=t+1,i=e.length;n<i;t+=1,n+=1)e[t]=e[n];e.pop()}(t,i);n.removeListener&&this.emit("removeListener",e,o||r)}return this},m.prototype.removeAllListeners=function(e){var r,t;if(!(t=this._events))return this;if(!t.removeListener)return 0===arguments.length?(this._events=new E,this._eventsCount=0):t[e]&&(0==--this._eventsCount?this._events=new E:delete t[e]),this;if(0===arguments.length){for(var n,i=Object.keys(t),s=0;s<i.length;++s)"removeListener"!==(n=i[s])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=new E,this._eventsCount=0,this}if("function"==typeof(r=t[e]))this.removeListener(e,r);else if(r)do{this.removeListener(e,r[r.length-1])}while(r[0]);return this},m.prototype.listeners=function(e){var r,t=this._events;return t&&(r=t[e])?"function"==typeof r?[r.listener||r]:function(e){for(var r=new Array(e.length),t=0;t<r.length;++t)r[t]=e[t].listener||e[t];return r}(r):[]},m.listenerCount=function(e,r){return"function"==typeof e.listenerCount?e.listenerCount(r):_.call(e,r)},m.prototype.listenerCount=_,m.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class C extends m{addEventListener(e,r){return super.addListener(e,r)}removeEventListener(e,r){return super.removeListener(e,r)}dispatchEvent(e,r){return super.emit(e,{type:e,target:this,value:r})}}class T{constructor(e){this.configurationValue=null,this.configurationName=null,this.interfaces=[],this.configurationValue=e.configurationValue,this.configurationName=e.configurationName,this.interfaces=e.interfaces}}class D{constructor(e){this.interfaceNumber=null,this.alternates=[],this._claimed=!1,this._currentAlternate=0,this._handle=null,this.interfaceNumber=e.interfaceNumber,this.alternates=e.alternates,this._handle=e._handle}get claimed(){return this._claimed}get alternate(){return this.alternates.find(e=>e.alternateSetting===this._currentAlternate)}selectAlternateInterface(e){return O.selectAlternateInterface(this._handle,this.interfaceNumber,e).then(()=>{this._currentAlternate=e})}claimInterface(){return O.claimInterface(this._handle,this.interfaceNumber).then(()=>{this._claimed=!0})}releaseInterface(){return O.releaseInterface(this._handle,this.interfaceNumber).then(()=>{this._claimed=!1})}reset(){this._currentAlternate=0}}class N{constructor(e){this.alternateSetting=null,this.interfaceClass=null,this.interfaceSubclass=null,this.interfaceProtocol=null,this.interfaceName=null,this.endpoints=[],this.alternateSetting=e.alternateSetting,this.interfaceClass=e.interfaceClass,this.interfaceSubclass=e.interfaceSubclass,this.interfaceProtocol=e.interfaceProtocol,this.interfaceName=e.interfaceName,this.endpoints=e.endpoints}}class S{constructor(e){this.endpointNumber=null,this.direction=null,this.type=null,this.packetSize=null,this.endpointNumber=e.endpointNumber,this.direction=e.direction,this.type=e.type,this.packetSize=e.packetSize}}const y=200,P=10,V={WEB_UUID:"3408b638-09a9-47a0-8bfd-a0768815b665",LIBUSB_DT_BOS:15,LIBUSB_DT_BOS_SIZE:5,LIBUSB_TRANSFER_TYPE_MASK:3,USB_VERSION:513,CAPABILITY_VERSION:256,URL_REQUEST_TYPE:192,URL_REQUEST_INDEX:2,CLEAR_FEATURE:1,ENDPOINT_HALT:0};class L extends m{constructor(){super(),this.devices={};const t=e=>{this.loadDevice(e,P).then(e=>{if(e){const r=this.getDeviceHandle(e);this.devicetoUSBDevice(r).then(e=>{e&&this.emit(L.EVENT_DEVICE_CONNECT,e)})}})},n=e=>{const r=this.getDeviceHandle(e);r&&this.devices[r]&&(delete this.devices[r],this.emit(L.EVENT_DEVICE_DISCONNECT,r))};this.on("newListener",r=>{0===this.listenerCount(r)&&(r===L.EVENT_DEVICE_CONNECT?e("attach",t):r===L.EVENT_DEVICE_DISCONNECT&&e("detach",n))}),this.on("removeListener",e=>{0===this.listenerCount(e)&&(e===L.EVENT_DEVICE_CONNECT?r("attach",t):e===L.EVENT_DEVICE_DISCONNECT&&r("detach",n))})}getDeviceHandle(e){return null===e.busNumber||null===e.deviceAddress?null:`${e.busNumber}.${e.deviceAddress}`}serialPromises(e,r){return r.reduce(function(r,t){return r.then(r=>e.call(this,t).then(e=>(e&&r.push(e),r)))}.bind(this),Promise.resolve([]))}serialDevicePromises(e,r,t){return t.reduce(function(t,n){return t.then(t=>e.call(this,r,n).then(e=>(t.push(e),t)))}.bind(this),Promise.resolve([]))}delay(e=y){return new Promise((r,t)=>{setTimeout(r,e)})}retryPromise(e,r=0,t=y){return new Promise((n,i)=>{e().then(n).catch(s=>0===r?i(s):this.delay(t).then(()=>this.retryPromise(e,--r,t)).then(n).catch(e=>i(e)))})}loadDevices(){this.devices={};const e=t();return this.serialPromises(this.loadDevice,e)}loadDevice(e,r=0){try{e.configDescriptor,e.allConfigDescriptors,e.deviceDescriptor}catch(e){return Promise.resolve(null)}return this.getCapabilities(e,r).then(e=>this.getWebCapability(e)).then(r=>this.getWebUrl(e,r).then(r=>{const t=this.getDeviceHandle(e);return this.devices[t]={device:e,url:r},e}))}getCapabilities(e,r){return new Promise((t,n)=>{this.openDevice(e,r).then(()=>{e.getCapabilities((r,n)=>{try{e.close()}catch(e){}if(r)return t([]);t(n)})}).catch(e=>{t([])})})}getWebCapability(e){return e.filter(e=>5===e.type).find(e=>{const r=this.decodeUUID(e.data.slice(1,17)),t=e.data.readUInt16LE(17);return r===V.WEB_UUID&&t===V.CAPABILITY_VERSION})}decodeUUID(e){const r=`00000000${e.readUInt32LE(0).toString(16)}`.slice(-8),t=`0000${e.readUInt16LE(4).toString(16)}`.slice(-4),n=`0000${e.readUInt16LE(6).toString(16)}`.slice(-4),i=[];for(let r=8;r<10;r++)i.push(`00${e.readUInt8(r).toString(16)}`.slice(-2));const s=[];for(let r=10;r<16;r++)s.push(`00${e.readUInt8(r).toString(16)}`.slice(-2));return`${r}-${t}-${n}-${i.join("")}-${s.join("")}`}getWebUrl(e,r,t=!0){return new Promise((n,i)=>{if(!r||!r.data||r.data.byteLength<20)return n(null);const s=r.data.readUInt8(19),o=r.data.readUInt8(20);this.openDevice(e).then(()=>{e.controlTransfer(V.URL_REQUEST_TYPE,s,o,V.URL_REQUEST_INDEX,64,(r,s)=>{if(e.close(),r)return t?n(null):i(r);let o=s.toString("utf8",3);const c=s.readUInt8(2);0===c&&(o="http://"+o),1===c&&(o="https://"+o),n(o)})}).catch(e=>{n("")})})}devicetoUSBDevice(e){return new Promise((r,t)=>{const n=this.devices[e].device,i=this.devices[e].url;let s=null,o=null,c=null;try{o=n.configDescriptor,s=n.allConfigDescriptors,c=n.deviceDescriptor}catch(e){return r(null)}return s?this.serialDevicePromises(this.configToUSBConfiguration,n,s).then(e=>{if(!c)return r(new U({_handle:this.getDeviceHandle(n),url:i,configurations:e}));const t=this.decodeVersion(c.bcdDevice),s=this.decodeVersion(c.bcdUSB);let a=null,u=null;return this.getStringDescriptor(n,c.iManufacturer).then(e=>(a=e,this.getStringDescriptor(n,c.iProduct))).then(e=>(u=e,this.getStringDescriptor(n,c.iSerialNumber))).then(l=>{const f={_handle:this.getDeviceHandle(n),_maxPacketSize:c.bMaxPacketSize0,url:i,deviceClass:c.bDeviceClass,deviceSubclass:c.bDeviceSubClass,deviceProtocol:c.bDeviceProtocol,productId:c.idProduct,vendorId:c.idVendor,deviceVersionMajor:t.major,deviceVersionMinor:t.minor,deviceVersionSubminor:t.sub,usbVersionMajor:s.major,usbVersionMinor:s.minor,usbVersionSubminor:s.sub,manufacturerName:a,productName:u,serialNumber:l,configurations:e,_currentConfiguration:o.bConfigurationValue};return r(new U(f))})}).catch(e=>{r(null)}):r(null)})}decodeVersion(e){const r=`0000${e.toString(16)}`.slice(-4);return{major:parseInt(r.substr(0,2),null),minor:parseInt(r.substr(2,1),null),sub:parseInt(r.substr(3,1),null)}}getStringDescriptor(e,r){return new Promise(t=>{this.openDevice(e).then(()=>{e.getStringDescriptor(r,(r,n)=>{e.close(),t(r?"":n.toString())})}).catch(e=>{t("")})})}bufferToDataView(e){const r=new Uint8Array(e).buffer;return new DataView(r)}bufferSourceToBuffer(e){const r=ArrayBuffer.isView(e)?e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):e;return Buffer.from(r)}getEndpoint(e,r,t){let s=null;const o=t|("in"===r?n:i);return e.interfaces.some(e=>{const r=e.endpoint(o);return!!r&&(s=r,!0)}),s}getInEndpoint(e,r){const t=this.getEndpoint(e,"in",r);if(t&&"in"===t.direction)return t}getOutEndpoint(e,r){const t=this.getEndpoint(e,"out",r);if(t&&"out"===t.direction)return t}endpointToUSBEndpoint(e){const r=e.bEndpointAddress&n?"in":"out";return new S({endpointNumber:e.bEndpointAddress^("in"===r?n:i),direction:r,type:(e.bmAttributes&V.LIBUSB_TRANSFER_TYPE_MASK)===s?"bulk":(e.bmAttributes&V.LIBUSB_TRANSFER_TYPE_MASK)===o?"interrupt":"isochronous",packetSize:e.wMaxPacketSize})}interfaceToUSBAlternateInterface(e,r){return this.getStringDescriptor(e,r.iInterface).then(e=>new N({alternateSetting:r.bAlternateSetting,interfaceClass:r.bInterfaceClass,interfaceSubclass:r.bInterfaceSubClass,interfaceProtocol:r.bInterfaceProtocol,interfaceName:e,endpoints:r.endpoints.map(this.endpointToUSBEndpoint)}))}interfacesToUSBInterface(e,r){return this.serialDevicePromises(this.interfaceToUSBAlternateInterface,e,r).then(t=>new D({_handle:this.getDeviceHandle(e),interfaceNumber:r[0].bInterfaceNumber,alternates:t}))}configToUSBConfiguration(e,r){return this.getStringDescriptor(e,r.iConfiguration).then(t=>{const n=r.interfaces||[];return this.serialDevicePromises(this.interfacesToUSBInterface,e,n).then(e=>new T({configurationValue:r.bConfigurationValue,configurationName:t,interfaces:e}))})}getDevice(e){return this.devices[e]?this.devices[e].device:null}controlTransferParamsToType(e,r){return("device"===e.recipient?c:"interface"===e.recipient?a:"endpoint"===e.recipient?u:l)|("standard"===e.requestType?f:"class"===e.requestType?d:h)|r}openDevice(e,r=0){return this.retryPromise(()=>new Promise((r,t)=>{try{e.open()}catch(e){return t(e)}r()}),r)}getConnected(e){return null!==this.getDevice(e)}getOpened(e){const r=this.getDevice(e);return!!r&&null!==r.interfaces}listUSBDevices(){return this.loadDevices().then(()=>this.serialPromises(this.devicetoUSBDevice,Object.keys(this.devices)))}open(e){const r=this.getDevice(e);return this.openDevice(r)}close(e){return new Promise((r,t)=>{this.getDevice(e).close(),r()})}selectConfiguration(e,r){return new Promise((t,n)=>{this.getDevice(e).setConfiguration(r,e=>{if(e)return n(e);t()})})}claimInterface(e,r){return new Promise((t,n)=>{this.getDevice(e).interface(r).claim(),t()})}releaseInterface(e,r){return new Promise((t,n)=>{this.getDevice(e).interface(r).release(!0,e=>{if(e)return n(e);t()})})}selectAlternateInterface(e,r,t){return new Promise((n,i)=>{this.getDevice(e).interface(r).setAltSetting(t,e=>{if(e)return i(e);n()})})}controlTransferIn(e,r,t){return new Promise((i,s)=>{const o=this.getDevice(e),c=this.controlTransferParamsToType(r,n);o.controlTransfer(c,r.request,r.value,r.index,t,(e,r)=>{if(e)return e.errno===v?i({status:"stall"}):e.errno===p?i({status:"babble"}):s(e);i({data:this.bufferToDataView(r),status:"ok"})})})}controlTransferOut(e,r,t){return new Promise((n,s)=>{const o=this.getDevice(e),c=this.controlTransferParamsToType(r,i),a=t?this.bufferSourceToBuffer(t):new Buffer(0);o.controlTransfer(c,r.request,r.value,r.index,a,e=>{if(e)return e.errno===v?n({bytesWritten:0,status:"stall"}):s(e);n({bytesWritten:a.byteLength,status:"ok"})})})}clearHalt(e,r,t){return new Promise((s,o)=>{const c=this.getDevice(e),a=t|("in"===r?n:i);c.controlTransfer(u,V.CLEAR_FEATURE,V.ENDPOINT_HALT,a,0,e=>{if(e)return o(e);s()})})}transferIn(e,r,t){return new Promise((n,i)=>{const s=this.getDevice(e);this.getInEndpoint(s,r).transfer(t,(e,r)=>{if(e)return e.errno===v?n({status:"stall"}):e.errno===p?n({status:"babble"}):i(e);n({data:this.bufferToDataView(r),status:"ok"})})})}transferOut(e,r,t){return new Promise((n,i)=>{const s=this.getDevice(e),o=this.getOutEndpoint(s,r),c=this.bufferSourceToBuffer(t);o.transfer(c,e=>{if(e)return e.errno===v?n({bytesWritten:0,status:"stall"}):i(e);n({bytesWritten:c.byteLength,status:"ok"})})})}isochronousTransferIn(e,r,t){return new Promise((e,r)=>{r("isochronousTransferIn error: method not implemented")})}isochronousTransferOut(e,r,t,n){return new Promise((e,r)=>{r("isochronousTransferOut error: method not implemented")})}reset(e){return new Promise((r,t)=>{this.getDevice(e).reset(e=>{if(e)return t(e);r()})})}}L.EVENT_DEVICE_CONNECT="connect",L.EVENT_DEVICE_DISCONNECT="disconnect";const O=new L;class U{constructor(e){this.manufacturerName=null,this.productName=null,this.serialNumber=null,this._configurations=[],this._currentConfiguration=null,this.url=null,this._maxPacketSize=0,this._handle=null,this.usbVersionMajor=e.usbVersionMajor,this.usbVersionMinor=e.usbVersionMinor,this.usbVersionSubminor=e.usbVersionSubminor,this.deviceClass=e.deviceClass,this.deviceSubclass=e.deviceSubclass,this.deviceProtocol=e.deviceProtocol,this.vendorId=e.vendorId,this.productId=e.productId,this.deviceVersionMajor=e.deviceVersionMajor,this.deviceVersionMinor=e.deviceVersionMinor,this.deviceVersionSubminor=e.deviceVersionSubminor,this.manufacturerName=e.manufacturerName,this.productName=e.productName,this.serialNumber=e.serialNumber,this._configurations=e.configurations,this.url=e.url,this._maxPacketSize=e._maxPacketSize,this._handle=e._handle,this._currentConfiguration=e._currentConfiguration}get configurations(){return this._configurations}get configuration(){return this.configurations.find(e=>e.configurationValue===this._currentConfiguration)}get connected(){return O.getConnected(this._handle)}get opened(){return O.getOpened(this._handle)}getEndpoint(e,r){let t=null,n=null;return this.configuration.interfaces.some(i=>((t=i.alternate.endpoints.find(t=>t.endpointNumber===r&&t.direction===e))&&(n=i),t)),{endpoint:t,iface:n}}setupInvalid(e){if("interface"===e.recipient){const r=255&e.index,t=this.configuration.interfaces.find(e=>e.interfaceNumber===r);if(!t)return"interface not found";if(!t.claimed)return"invalid state"}else if("endpoint"===e.recipient){const r=15&e.index,t=e.index&n?"in":"out",i=this.getEndpoint(t,r);if(!i.endpoint)return"endpoint not found";if(!i.iface.claimed)return"invalid state"}}open(){return new Promise((e,r)=>this.connected?this.opened?e():void O.open(this._handle).then(e).catch(e=>{r(new Error(`open error: ${e}`))}):r(new Error("open error: device not found")))}close(){return new Promise((e,r)=>{if(!this.connected)return r(new Error("close error: device not found"));if(!this.opened)return e();const t=this.configuration.interfaces.map(e=>this.releaseInterface(e.interfaceNumber));Promise.all(t).catch(e=>{}).then(()=>O.close(this._handle)).then(e).catch(e=>{r(new Error(`close error: ${e}`))})})}selectConfiguration(e){return new Promise((r,t)=>{if(e===this._currentConfiguration)return r();if(!this.connected)return t(new Error("selectConfiguration error: device not found"));return this.configurations.find(r=>r.configurationValue===e)?this.opened?void O.selectConfiguration(this._handle,e).then(()=>{this._currentConfiguration=e,this.configuration.interfaces.forEach(e=>e.reset()),r()}).catch(e=>{t(new Error(`selectConfiguration error: ${e}`))}):t(new Error("selectConfiguration error: invalid state")):t(new Error("selectConfiguration error: configuration not found"))})}claimInterface(e){return new Promise((r,t)=>{if(!this.connected)return t(new Error("claimInterface error: device not found"));const n=this.configuration.interfaces.find(r=>r.interfaceNumber===e);return n?this.opened?n.claimed?r():void n.claimInterface().then(r).catch(e=>{t(new Error(`claimInterface error: ${e}`))}):t(new Error("claimInterface error: invalid state")):t(new Error("claimInterface error: interface not found"))})}releaseInterface(e){return new Promise((r,t)=>{if(!this.connected)return t(new Error("releaseInterface error: device not found"));const n=this.configuration.interfaces.find(r=>r.interfaceNumber===e);return n?this.opened?n.claimed?void n.releaseInterface().then(r).catch(e=>{t(new Error(`releaseInterface error: ${e}`))}):r():t(new Error("releaseInterface error: invalid state")):t(new Error("releaseInterface error: interface not found"))})}selectAlternateInterface(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("selectAlternateInterface error: device not found"));const i=this.configuration.interfaces.find(r=>r.interfaceNumber===e);return i?this.opened&&i.claimed?void i.selectAlternateInterface(r).then(t).catch(e=>{n(new Error(`selectAlternateInterface error: ${e}`))}):n(new Error("selectAlternateInterface error: invalid state")):n(new Error("selectAlternateInterface error: interface not found"))})}controlTransferIn(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("controlTransferIn error: device not found"));if(!this.opened)return n(new Error("controlTransferIn error: invalid state"));const i=this.setupInvalid(e);if(i)return n(new Error(`controlTransferIn error: ${i}`));O.controlTransferIn(this._handle,e,r).then(t).catch(e=>{n(new Error(`controlTransferIn error: ${e}`))})})}controlTransferOut(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("controlTransferOut error: device not found"));if(!this.opened)return n(new Error("controlTransferOut error: invalid state"));const i=this.setupInvalid(e);if(i)return n(new Error(`controlTransferOut error: ${i}`));O.controlTransferOut(this._handle,e,r).then(t).catch(e=>{n(new Error(`controlTransferOut error: ${e}`))})})}clearHalt(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("clearHalt error: device not found"));const i=this.getEndpoint(e,r);return i.endpoint?this.opened&&i.iface.claimed?void O.clearHalt(this._handle,e,r).then(t).catch(e=>{n(new Error(`clearHalt error: ${e}`))}):n(new Error("clearHalt error: invalid state")):n(new Error("clearHalt error: endpoint not found"))})}transferIn(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("transferIn error: device not found"));const i=this.getEndpoint("in",e);return i.endpoint?"interrupt"!==i.endpoint.type&&"bulk"!==i.endpoint.type?n(new Error("transferIn error: invalid access")):this.opened&&i.iface.claimed?void O.transferIn(this._handle,e,r).then(t).catch(e=>{n(new Error(`transferIn error: ${e}`))}):n(new Error("transferIn error: invalid state")):n(new Error("transferIn error: endpoint not found"))})}transferOut(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("transferOut error: device not found"));const i=this.getEndpoint("out",e);return i.endpoint?"interrupt"!==i.endpoint.type&&"bulk"!==i.endpoint.type?n(new Error("transferOut error: invalid access")):this.opened&&i.iface.claimed?void O.transferOut(this._handle,e,r).then(t).catch(e=>{n(new Error(`transferOut error: ${e}`))}):n(new Error("transferOut error: invalid state")):n(new Error("transferOut error: endpoint not found"))})}isochronousTransferIn(e,r){return new Promise((t,n)=>{if(!this.connected)return n(new Error("isochronousTransferIn error: device not found"));const i=this.getEndpoint("in",e);return i.endpoint?"isochronous"!==i.endpoint.type?n(new Error("isochronousTransferIn error: invalid access")):this.opened&&i.iface.claimed?void O.isochronousTransferIn(this._handle,e,r).then(t).catch(e=>{n(new Error(`isochronousTransferIn error: ${e}`))}):n(new Error("isochronousTransferIn error: invalid state")):n(new Error("isochronousTransferIn error: endpoint not found"))})}isochronousTransferOut(e,r,t){return new Promise((n,i)=>{if(!this.connected)return i(new Error("isochronousTransferOut error: device not found"));const s=this.getEndpoint("out",e);return s.endpoint?"isochronous"!==s.endpoint.type?i(new Error("isochronousTransferOut error: invalid access")):this.opened&&s.iface.claimed?void O.isochronousTransferOut(this._handle,e,r,t).then(n).catch(e=>{i(new Error(`isochronousTransferOut error: ${e}`))}):i(new Error("isochronousTransferOut error: invalid state")):i(new Error("isochronousTransferOut error: endpoint not found"))})}reset(){return new Promise((e,r)=>this.connected?this.opened?void O.reset(this._handle).then(e).catch(e=>{r(new Error(`reset error: ${e}`))}):r(new Error("reset error: invalid state")):r(new Error("reset error: device not found")))}}class A extends C{constructor(e){super(),this.allowedDevices=[],e=e||{},this.devicesFound=e.devicesFound;const r=e=>{this.replaceAllowedDevice(e)&&this.emit(A.EVENT_DEVICE_CONNECT,e)},t=e=>{const r=this.allowedDevices.find(r=>r._handle===e);r&&this.emit(A.EVENT_DEVICE_DISCONNECT,r)};this.on("newListener",e=>{0===this.listenerCount(e)&&(e===A.EVENT_DEVICE_CONNECT?O.addListener(L.EVENT_DEVICE_CONNECT,r):e===A.EVENT_DEVICE_DISCONNECT&&O.addListener(L.EVENT_DEVICE_DISCONNECT,t))}),this.on("removeListener",e=>{0===this.listenerCount(e)&&(e===A.EVENT_DEVICE_CONNECT?O.removeListener(L.EVENT_DEVICE_CONNECT,r):e===A.EVENT_DEVICE_DISCONNECT&&O.removeListener(L.EVENT_DEVICE_DISCONNECT,t))})}replaceAllowedDevice(e){for(const r in this.allowedDevices)if(this.isSameDevice(e,this.allowedDevices[r]))return this.allowedDevices[r]=e,!0;return!1}isSameDevice(e,r){return e.productId===r.productId&&e.vendorId===r.vendorId&&e.serialNumber===r.serialNumber}filterDevice(e,r){return e.filters.some(e=>{if(e.vendorId&&e.vendorId!==r.vendorId)return!1;if(e.productId&&e.productId!==r.productId)return!1;if(e.classCode){if(r.configuration.interfaces.some(r=>(!e.classCode||e.classCode===r.alternate.interfaceClass)&&((!e.subclassCode||e.subclassCode===r.alternate.interfaceSubclass)&&(!e.protocolCode||e.protocolCode===r.alternate.interfaceProtocol))))return!0}return(!e.classCode||e.classCode===r.deviceClass)&&((!e.subclassCode||e.subclassCode===r.deviceSubclass)&&((!e.protocolCode||e.protocolCode===r.deviceProtocol)&&(!e.serialnumber||e.serialnumber===r.serialNumber)))})}getDevices(){return O.listUSBDevices().then(e=>{return e.filter(e=>{if(!e.connected)return!1;for(const r in this.allowedDevices)if(this.isSameDevice(e,this.allowedDevices[r]))return!0;return!1})})}requestDevice(e){return new Promise((r,t)=>{if(!e)return t(new TypeError("requestDevice error: 1 argument required, but only 0 present"));if(e.constructor!=={}.constructor)return t(new TypeError("requestDevice error: parameter 1 (options) is not an object"));if(!e.filters)return t(new TypeError("requestDevice error: required member filters is undefined"));if(e.filters.constructor!==[].constructor)return t(new TypeError("requestDevice error: the provided value cannot be converted to a sequence"));return e.filters.every(e=>e.protocolCode&&!e.subclassCode?(t(new TypeError("requestDevice error: subclass code is required")),!1):!(e.subclassCode&&!e.classCode)||(t(new TypeError("requestDevice error: class code is required")),!1))?O.listUSBDevices().then(n=>{if(0===(n=n.filter(r=>this.filterDevice(e,r))).length)return t(new Error("requestDevice error: no devices found"));function i(e){if(!(e instanceof U))return t(new Error("requestDevice error: invalid device type."));this.replaceAllowedDevice(e)||this.allowedDevices.push(e),r(e)}return this.devicesFound?this.devicesFound(n).then(e=>{if(e)return i.call(this,e)}):i.call(this,n[0])}).catch(e=>{t(new Error(`requestDevice error: ${e}`))}):void 0})}}A.EVENT_DEVICE_CONNECT="connect",A.EVENT_DEVICE_DISCONNECT="disconnect";const B=new A;export{A as USB,L as USBAdapter,N as USBAlternateInterface,T as USBConfiguration,U as USBDevice,S as USBEndpoint,D as USBInterface,O as adapter,B as usb};
//# sourceMappingURL=webusb.esm.js.map
